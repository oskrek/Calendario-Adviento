<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Sorpresa Misteriosa</title>
    <link rel="stylesheet" href="style-sorpresa.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  </head>
  <body>
    <!-- Loader navide√±o -->
    <div id="loader">
      <!-- Aqu√≠ pones tu GIF de regalo -->
      <img src="assets/images/regalo.PNG" alt="Cargando sorpresa..." />
    </div>

    <!-- Contenido real -->
    <div id="contenido-wrapper">
      <h1 id="titulo"></h1>
      <p id="contenido"></p>
      <div id="extra"></div>
      <div class="boton-container">
        <a href="index.html" class="boton-link">‚¨ÖÔ∏è Volver al calendario</a>
      </div>
    </div>

    <!-- Modal oculto -->
    <div class="image-modal" id="imageModal">
      <span class="close" id="closeModal">‚úñ</span>
      <img id="modalImg" src="" alt="Imagen expandida" />
    </div>

    <script>
      // Detectar cuando la p√°gina termin√≥ de cargar
      window.addEventListener("load", () => {
        document.body.classList.add("loaded");
      });

      // Obtener el par√°metro "dia" de la URL
      const params = new URLSearchParams(window.location.search);
      const dia = params.get("dia");
      const token = params.get("token");
      const tokenEsperado = sessionStorage.getItem(`tokenDia${dia}`);

      if (token !== tokenEsperado) {
        alert("No puedes ver este contenido. Ser√°s redirigido al calendario.");
        window.location.href = "index.html";
      } else {
        sessionStorage.removeItem(`tokenDia${dia}`);
      }

      document.getElementById(
        "titulo"
      ).textContent = `üéÅ Sorpresa del D√≠a ${dia} üéÅ`;

      const sorpresas = {
        1: "Portadas de Pel√≠cula",
        2: "Rescata Al Viewer I",
        3: "Cartas Mimosas Parte I",
        4: "Rescata Al Viewer II",
        5: "FanArts con IA",
        6: "Fondos De Pantalla I",
        7: "Canci√≥n De Suno I",
        8: "Cartas Mimosas Parte II",
        9: "Rescata Al Viewer III",
        10: "Cartas Mimosas Parte III",
        11: "Fondos De Pantalla II",
        12: "Rescata Al Viewer IV",
        13: "FanArts",
        14: "Canci√≥n De Suno II",
        15: "Rompecabezas",
        16: "Adivina El Aitoner I",
        17: "Adivina El Aitoner II",
        18: "FanArts II",
        19: "Rompecabezas II",
        20: "Juego",
        21: "Rompecabezas III",
        22: "Canci√≥n De Suno III",
        23: "Premios De La Comunidad",
        24: "Clips Del A√±o",
        25: "Rompecabezas",
      };

      document.getElementById("contenido").textContent =
        sorpresas[dia] || "Una sorpresa envuelta en sombras...";

      // Cargar autom√°ticamente un archivo extra si existe
      const rutaExtra = `extras/dia${dia}.html`;
      const rutaJs = `extras/dia${dia}.js`;
      fetch(rutaExtra)
        .then((response) => {
          if (!response.ok)
            throw new Error("No existe archivo extra para este d√≠a");
          return response.text();
        })
        .then((html) => {
          document.getElementById("extra").innerHTML = html;
          inicializarJs(dia);
        })
        .catch((err) => {
          console.log("Sin extra para este d√≠a:", err.message);
        });

      document.addEventListener("click", (e) => {
        const btn = e.target.closest("#reload-iframe");
        if (!btn) return;

        const iframe = document.getElementById("portal-dia2");
        if (!iframe) return;

        const originalSrc = iframe.getAttribute("src");
        const url = new URL(originalSrc, window.location.href);
        url.searchParams.set("_t", Date.now());
        iframe.src = url.toString();
      });

      function inicializarJs(dia) {
        dia = Number(dia);
        switch (dia) {
          case 1:
          case 3:
          case 5:
          case 6:
          case 8:
          case 10:
          case 11:
          case 13:
          case 18:
            inicializarCarrusel();
            break;
          case 7:
          case 14:
            inicializarReproductor();
            break;
          case 22:
            inicializarReproductor2();
            break;
        }
      }

      function inicializarCarrusel() {
        const carousel = document.getElementById("carousel");
        const items = document.querySelectorAll(".carousel-item");
        const indicators = document.getElementById("indicators");
        const prevBtn = document.querySelector(".prev");
        const nextBtn = document.querySelector(".next");

        let index = 0;

        // Crear indicadores
        indicators.innerHTML = ""; // limpiar si ya existen
        items.forEach((_, i) => {
          const dot = document.createElement("span");
          if (i === 0) dot.classList.add("active");
          indicators.appendChild(dot);
        });

        function updateIndicators(i) {
          indicators.querySelectorAll("span").forEach((dot, idx) => {
            dot.classList.toggle("active", idx === i);
          });
        }

        function scrollToIndex(i) {
          const itemWidth = items[0].offsetWidth;
          carousel.scrollTo({ left: i * itemWidth, behavior: "smooth" });
          updateIndicators(i);
          index = i;
        }

        prevBtn.addEventListener("click", () => {
          if (index > 0) scrollToIndex(index - 1);
        });

        nextBtn.addEventListener("click", () => {
          if (index < items.length - 1) scrollToIndex(index + 1);
        });

        carousel.addEventListener("scroll", () => {
          const newIndex = Math.round(
            carousel.scrollLeft / items[0].offsetWidth
          );
          if (newIndex !== index) updateIndicators(newIndex);
          index = newIndex;
        });

        const images = document.querySelectorAll(".carousel-item img");
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImg");
        const closeModal = document.getElementById("closeModal");

        // Al hacer clic en una imagen ‚Üí mostrar modal
        images.forEach((img) => {
          img.addEventListener("click", () => {
            modal.style.display = "flex";
            modalImg.src = img.src;
            modalImg.alt = img.alt;
          });
        });

        // Cerrar modal
        closeModal.addEventListener("click", () => {
          modal.style.display = "none";
        });

        // Tambi√©n cerrar si se hace clic fuera de la imagen
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });

        document
          .getElementById("downloadAllBtn")
          .addEventListener("click", async function () {
            const zip = new JSZip();
            const images = document.querySelectorAll(
              "#carousel .carousel-item"
            );
            const imgFolder = zip.folder("fondos");

            for (let i = 0; i < images.length; i++) {
              const item = images[i];
              const img = item.querySelector("img");
              const caption =
                item.querySelector(".caption")?.textContent.trim() ||
                "autor_desconocido";

              // Extraer nombre y extensi√≥n desde la URL
              const urlParts = img.src.split("/");
              const fullName = urlParts[urlParts.length - 1]; // ej. deAri5.jpg
              const extension = fullName.split(".").pop(); // ej. jpg
              const baseName =
                img.alt.replace(/\s+/g, "_") || `imagen_${i + 1}`;
              const autor = caption
                .replace("Hecha por ", "")
                .replace(/\s+/g, "_");
              const filename = `${baseName}_${autor}.${extension}`;

              try {
                const response = await fetch(img.src);
                const blob = await response.blob();
                imgFolder.file(filename, blob);
              } catch (error) {
                console.error("Error descargando la imagen:", img.src, error);
              }
            }

            zip.generateAsync({ type: "blob" }).then(function (content) {
              saveAs(content, "fondos.zip");
            });
          });
      }

      function inicializarReproductor() {
        const audio = document.getElementById("audio");
        const playBtn = document.getElementById("play");
        const pauseBtn = document.getElementById("pause");
        const stopBtn = document.getElementById("stop");
        const volume = document.getElementById("volume");
        const statusEl = document.getElementById("status");
        const timeEl = document.getElementById("time");
        const downloadBtn = document.getElementById("download");

        // Estado inicial
        audio.volume = parseFloat(volume.value);

        // Formatear tiempo mm:ss
        function fmt(seconds) {
          if (!isFinite(seconds)) return "00:00";
          const m = Math.floor(seconds / 60);
          const s = Math.floor(seconds % 60);
          return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        }

        // Actualizar tiempo cada segundo
        let timer = null;
        function startTimer() {
          if (timer) return;
          timer = setInterval(() => {
            timeEl.textContent = fmt(audio.currentTime);
          }, 500);
        }
        function stopTimer() {
          clearInterval(timer);
          timer = null;
        }

        // Eventos de control
        playBtn.addEventListener("click", () => {
          audio.play();
          statusEl.textContent = "Reproduciendo";
          startTimer();
        });

        pauseBtn.addEventListener("click", () => {
          audio.pause();
          statusEl.textContent = "Pausado";
          stopTimer();
        });

        stopBtn.addEventListener("click", () => {
          audio.pause();
          audio.currentTime = 0;
          statusEl.textContent = "Detenido";
          timeEl.textContent = "00:00";
          stopTimer();
        });

        volume.addEventListener("input", () => {
          audio.volume = parseFloat(volume.value);
        });

        // Estado cuando termina
        audio.addEventListener("ended", () => {
          statusEl.textContent = "Finalizado";
          stopTimer();
        });

        // Preparado
        audio.addEventListener("canplay", () => {
          statusEl.textContent = "Listo";
        });

        // Descargar
        downloadBtn.addEventListener("click", () => {
          const src = audio.querySelector("source").src;
          const fileName = src.split("/").pop();
          const a = document.createElement("a");
          a.href = src;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
      }
      function inicializarReproductor2() {
        const audio = document.getElementById("audio");
        const playBtn = document.getElementById("play");
        const pauseBtn = document.getElementById("pause");
        const stopBtn = document.getElementById("stop");
        const volume = document.getElementById("volume");
        const statusEl = document.getElementById("status");
        const timeEl = document.getElementById("time");
        const downloadBtn = document.getElementById("download");
        const titleEl = document.getElementById("track-title");
        const artistEl = document.getElementById("track-artist");
        const playlistEl = document.getElementById("playlist");

        // üéµ Playlist
        const playlist = [
          {
            src: "assets/canciones/corrido del rey del bug.mp3",
            title: "El rey del bug",
            artist: "Aitoners Group",
          }/*,
          {
            src: "media/festive_theme.mp3",
            title: "Cancion de Lu",
            artist: "Aitoners Group",
          }*/,
          {
            src: "assets/canciones/La cumbia aitoner.mp3",
            title: "Streamer de 20 viewers",
            artist: "Aitoners Group",
          },
          ,
          {
            src: "assets/canciones/Villancicovide.mp3",
            title: "VillancicoVide",
            artist: "Aitoners Group",
          }
        ];
        let currentIndex = 0;

        // Formatear tiempo mm:ss
        function fmt(seconds) {
          if (!isFinite(seconds)) return "00:00";
          const m = Math.floor(seconds / 60);
          const s = Math.floor(seconds % 60);
          return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        }

        // Timer
        let timer = null;
        function startTimer() {
          if (timer) return;
          timer = setInterval(() => {
            timeEl.textContent = fmt(audio.currentTime);
          }, 500);
        }
        function stopTimer() {
          clearInterval(timer);
          timer = null;
        }

        // üéº Cargar canci√≥n
        function cargarCancion(index) {
          const track = playlist[index];
          if (!track) return;
          audio.src = track.src;
          titleEl.textContent = track.title;
          artistEl.textContent = track.artist;
          timeEl.textContent = "00:00";
          statusEl.textContent = "Listo";
          marcarActivo(index);
        }

        // üé® Pintar lista
        function renderPlaylist() {
          playlistEl.innerHTML = "";
          playlist.forEach((track, i) => {
            const div = document.createElement("div");
            div.className = "track";
            div.textContent = `${track.title} ‚Äî ${track.artist}`;
            div.addEventListener("click", () => {
              currentIndex = i;
              cargarCancion(currentIndex);
              audio.play();
              statusEl.textContent = "Reproduciendo";
              startTimer();
            });
            playlistEl.appendChild(div);
          });
          marcarActivo(currentIndex);
        }

        // üî¥ Resaltar canci√≥n activa
        function marcarActivo(index) {
          [...playlistEl.children].forEach((el, i) => {
            el.classList.toggle("active", i === index);
          });
        }

        // Controles
        playBtn.addEventListener("click", () => {
          audio.play();
          statusEl.textContent = "Reproduciendo";
          startTimer();
        });

        pauseBtn.addEventListener("click", () => {
          audio.pause();
          statusEl.textContent = "Pausado";
          stopTimer();
        });

        stopBtn.addEventListener("click", () => {
          audio.pause();
          audio.currentTime = 0;
          statusEl.textContent = "Detenido";
          timeEl.textContent = "00:00";
          stopTimer();
        });

        volume.addEventListener("input", () => {
          audio.volume = parseFloat(volume.value);
        });

        audio.addEventListener("ended", () => {
          statusEl.textContent = "Finalizado";
          stopTimer();
          // üîÑ Auto-next
          currentIndex = (currentIndex + 1) % playlist.length;
          cargarCancion(currentIndex);
          audio.play();
          statusEl.textContent = "Reproduciendo";
          startTimer();
        });

        audio.addEventListener("canplay", () => {
          statusEl.textContent = "Listo";
        });

        downloadBtn.addEventListener("click", () => {
          const src = audio.src;
          const fileName = src.split("/").pop();
          const a = document.createElement("a");
          a.href = src;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

        // Inicializar
        cargarCancion(currentIndex);
        renderPlaylist();
      }
    </script>
  </body>
</html>
